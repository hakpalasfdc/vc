<apex:page standardController="Case" extensions="VSPR3_ConsumerSearch_USC" lightningStylesheets="true" Title="Consumer Search" name="ConsumerSearch" id="searchpage">
    <apex:includeScript value="{!URLFOR($Resource.cnx__CnxSfdcResources,'js/ConnectsIntegrationAPI.min.js')}"/>
    <apex:includeScript value="/support/console/43.0/integration.js"/>
    <apex:includeScript value="/soap/ajax/38.0/connection.js"/>
    <apex:includeScript value="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"/>
    <script type="text/javascript">
        ConnectsIntegrationAPI.onWorkItemConnect = function (event) {
            console.log('USC onworkitemconnect');
            var workItemType = ConnectsIntegrationAPI.WORKITEM.TYPE.VOICE;
            var firstWorkItemData = ConnectsIntegrationAPI.getFirstWorkItem(workItemType);
            var calldirection = firstWorkItemData.Direction;

            if (firstWorkItemData.Direction == 'inbound' && !firstWorkItemData.IsInternalCall && event.item.CallType != 'CONSULT'){
                var contactId = firstWorkItemData.PerVar4;
                var primaryMemberConsumerId = firstWorkItemData.PerVar6;
                var clientIdLength = firstWorkItemData.PerVar3.length;
                var classDivStr = firstWorkItemData.PerVar3.substring(clientIdLength - 8,clientIdLength);
                var clntId = firstWorkItemData.PerVar3.substring(0,clientIdLength - 8);
                var divId = classDivStr.substring(0,classDivStr.length-4);
                var classId = classDivStr.substring(4,classDivStr.length);
                var intentCodeList = firstWorkItemData.PerVar7;
                var intentCodeLength = firstWorkItemData.PerVar7.length;
                var lastCommaIndex = intentCodeList.lastIndexOf(',');
                
                if(lastCommaIndex == -1){
                    lastCommaIndex = 0;
                }
                else{
                    lastCommaIndex += 1
                }
                var intentCode = intentCodeList.substring(lastCommaIndex,intentCodeLength);

                var callerEnteredPhone = firstWorkItemData.PerVar1;
                var ani = firstWorkItemData.Sender; 
                var dnis = firstWorkItemData.DialedNumber;
                var channel = event.item.Channel;
                var callType;
                var dependentConsumerId = '';
                var today = new Date();
                var month = today.getMonth()+1;
                var callerType;
                
                if(dnis == '18669180831' || dnis == '18778135112' || dnis == '18006151883'){
					callerType = 'Provider'; 
				}
				else if(dnis == '18667733260' || dnis == '18443443650' || dnis == '18774787557' || dnis == '18556383931' || dnis == '19162315951' || dnis == '19168532393'){///19168532393 is test number
					callerType = 'Retail Partner';
				}
				else{
					callerType = 'Member';                        
				}
                
                if(month < 10){
                    month = '0'+month;
                }
                var day = today.getDate();
                if(day < 10){
                    day = '0'+day;
                }
                var asofdate = today.getFullYear()+''+month+''+day;
                
                for (var k = 0; k < firstWorkItemData.NamedVariables.length; k++) {
                    if(firstWorkItemData.NamedVariables[k].Key=="user.CallTypePop")
                    {
                        callType = firstWorkItemData.NamedVariables[k].Value;
                    }
                }
                 
                Visualforce.remoting.Manager.invokeAction('{!$RemoteAction.VSPR3_ConsumerSearch_USC.createUSCCase}',
                    contactId,primaryMemberConsumerId,clntId,divId,classId,intentCode,callerEnteredPhone,ani,dnis,channel,callerType,callType,
                    function(caseCreateResult, event){
                        if (event.status) {
                            console.log('USC Case successfully created');
							Visualforce.remoting.Manager.invokeAction('{!$RemoteAction.VSPR3_ConsumerSearch_USC.getCCPURL}',
                    			function(result, event){
                        			if (event.status) {
                                        console.log('CCP URL successfully retrieved');
                            			refreshCCPortal(clntId,divId,dependentConsumerId,contactId,channel,asofdate,result,primaryMemberConsumerId);
									}
							    }
							);
                            sforce.console.openPrimaryTab(null,'/lightning/r/Case/'+caseCreateResult+'/view',true);
                        }
                        else{
                            console.log('USC Case creation failure');    
                        }
                    }                                         
                )
            } 
        }
        
        function refreshCCPortal(clientId,divId,dependentConsumerId,ciscoContactId,channel,sfAOD,ccp,primaryMemberConsumerId){
            if(sfAOD === '' || sfAOD === null ){
                var today = new Date();
                var month = today.getMonth()+1;
                if(month < 10){
                    month = '0'+month;
                }
                var day = today.getDate();
                if(day < 10){
                    day = '0'+day;
                }
                sfAOD = today.getFullYear()+''+month+''+day;
            }
            var ccpWindow = window.open('','CCPortalWindow');
            var ccpURL;

            if(dependentConsumerId === '' || dependentConsumerId === null){
                ccpURL = ccp+'/csrportal/ctiEvent/answered?SalesforceReadOnlyMode=True&clientId='+clientId+'&divisionId='+divId+'&sfAsOfDate='+sfAOD+'&subscriberConsumerId='+primaryMemberConsumerId;
            }
            else{
                ccpURL = ccp+'/csrportal/ctiEvent/answered?SalesforceReadOnlyMode=True&clientId='+clientId+'&divisionId='+divId+'&dependentConsumerId='+dependentConsumerId+'&sfAsOfDate='+sfAOD+'&subscriberConsumerId='+primaryMemberConsumerId;
            }

            if(channel == 'VOICE'){
                ccpURL = ccpURL + '&contactId='+ciscoContactId;
            }

            ccpWindow.document.getElementById("showPortal").src = ccpURL;
            console.log('CCP Refresh URL in BSAPI = ' + ccpURL);
        }
        
        ConnectsIntegrationAPI.onAgentStateChange = function (event) {
            var agentCTIData = ConnectsIntegrationAPI.getCtiData();
            var agentState;
            for (var k = 0; k < agentCTIData.Channels.length; k++) {
                if(agentCTIData.Channels[k].Name == "VOICE")
                {
                    agentState = agentCTIData.Channels[k].State;
                    console.log('Agent State = '+agentState);
                }
            }
            
            if(agentState == 'READY'){
                console.log('Agent State is READY');
                var ccpWindow = window.open('','CCPortalWindow');
                Visualforce.remoting.Manager.invokeAction('{!$RemoteAction.VSPR3_ConsumerSearch_USC.getCCPURL}',
                    function(result, event){
                        if (event.status) {
                            console.log('CCP URL = '+result);
                            ccpWindow.document.getElementById("showPortal").src = result+'/csrportal/ctiEvent/ready?reset=true';
                            location.reload(true);
                        }
                        else{
                            console.log('Failure to retrieve CCP URL');
						}
                    }                                         
                );
                Visualforce.remoting.Manager.invokeAction('{!$RemoteAction.VSPR3_ConsumerSearch_USC.finalReset}',
                    function(result, event){
                        if (event.status) {
                        }
                        else{
							console.log('Failure to perform final reset');
                        }
                    }                                         
                );
            }
        }
    </script>
</apex:page>